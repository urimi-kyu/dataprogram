<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>개별 종목 재난 영향 분석</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; }
        .container { max-width: 900px; }
        #results-container { margin-top: 30px; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="mb-4 text-center">개별 종목 재난 영향 분석</h1>
    <p class="text-center">
        <a href="/">섹터 분석으로 돌아가기 &#x25BA;</a>
    </p>

    <form id="individual-analysis-form" class="bg-light p-4 rounded shadow-sm">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="type-select" class="form-label">1. 재난 종류 선택 (EventType):</label>
                <select class="form-select" id="type-select" required>
                    <option value="">-- 종류를 선택하세요 --</option>
                    </select>
            </div>

            <div class="col-md-6 mb-3">
                <label for="event-select" class="form-label">2. 분석할 재난 이벤트 선택 (EventName):</label>
                <select class="form-select" id="event-select" name="event_name" required disabled>
                    <option value="">-- 재난 종류를 먼저 선택하세요 --</option>
                </select>
            </div>
            
        </div>
        
        <div class="mb-3">
            <label for="corp-name-input" class="form-label">3. 분석할 회사 이름 입력 (정확한 종목명):</label>
            <input type="text" class="form-control" id="corp-name-input" name="corp_name" placeholder="예: 삼성전자" required>
        </div>

        <button type="submit" class="btn btn-primary w-100 mt-2">분석 시작</button>
    </form>

    <div id="results-container">
        <div id="loading-indicator" class="text-center" style="display:none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">데이터를 조회하고 차트를 생성 중입니다...</p>
        </div>
        
        <div id="error-message" class="alert alert-danger" style="display:none;"></div>
        
        <div id="analysis-info" class="alert alert-info mt-4" style="display:none;"></div>
        
        <h4 id="table-title" style="display:none;" class="mt-4">성과 요약</h4>
        <div id="analysis-table" class="mb-5"></div>
        
        <h4 id="chart-title" style="display:none;">주가 변동 차트</h4>
        <div id="analysis-chart" class="text-center">
            <img id="chart-img" class="img-fluid" alt="종목 분석 차트">
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const typeSelect = $('#type-select'); // 1단계: 재난 종류 선택
    const eventSelect = $('#event-select'); // 2단계: 재난명 선택

    // --- 1. 페이지 로드시 재난 종류 목록 채우기 ---
    function loadDisasterTypes() {
        $.getJSON('/api/types', function(data) {
            if (data.error) {
                console.error("재난 종류 로드 오류:", data.error);
                return;
            }
            data.types.forEach(type => {
                typeSelect.append(new Option(type, type));
            });
        }).fail(function() {
            alert("재난 종류 목록을 서버에서 가져오는 데 실패했습니다.");
        });
    }

    // --- 2. 재난 종류 선택 시, 해당 이벤트 목록 채우기 ---
    typeSelect.change(function() {
        const selectedType = $(this).val();
        eventSelect.empty().prop('disabled', true).val('');
        
        if (!selectedType) {
            eventSelect.append(new Option('-- 재난 종류를 먼저 선택하세요 --', '')).prop('disabled', true);
            return;
        }

        eventSelect.append(new Option('목록을 불러오는 중...', '')).prop('disabled', true);
        
        const encodedType = encodeURIComponent(selectedType);
        
        $.getJSON(`/api/events_by_type/${encodedType}`, function(data) {
            if (data.error) {
                eventSelect.empty().append(new Option('데이터 로드 실패', '')).prop('disabled', true);
                console.error("이벤트 로드 오류:", data.error);
                return;
            }
            
            eventSelect.append(new Option('-- 재난명을 선택하세요 --', ''));
            data.events.forEach(event => {
                eventSelect.append(new Option(event, event));
            });
            eventSelect.prop('disabled', false); // 이벤트 목록 로드 완료 후 활성화

        }).fail(function() {
            eventSelect.empty().append(new Option('데이터 로드 실패', '')).prop('disabled', true);
        });
    });

    // --- 3. 폼 제출 로직 (기존과 동일) ---
    $('#individual-analysis-form').submit(function(e) {
        e.preventDefault(); 

        const eventName = eventSelect.val(); // 2단계 선택된 재난명
        const corpName = $('#corp-name-input').val();
        
        if (!eventName || !corpName) {
            alert("재난명과 회사 이름을 모두 입력/선택해주세요.");
            return;
        }

        // --- 초기화 및 로딩 설정 ---
        $('#loading-indicator').show();
        $('#analysis-info, #error-message, #analysis-table, #table-title, #chart-title').hide().empty();
        $('#chart-img').attr('src', '');

        $.ajax({
            type: 'POST',
            url: '/individual_analysis', 
            data: { event_name: eventName, corp_name: corpName }, // 서버로 전송
            dataType: 'json',
            success: function(response) {
                $('#loading-indicator').hide();
                
                if (response.error || response.status !== 'success') {
                    const errorMsg = response.error || '알 수 없는 분석 실패 오류가 발생했습니다.';
                    $('#error-message').html('<strong>분석 실패:</strong> ' + errorMsg).show();
                    return;
                }

                const data = response.analysis_data;

                // 1. 분석 정보 표시
                $('#analysis-info').html(
                    `<strong>분석 종목:</strong> ${data.corp_name} <br>` +
                    `<strong>기준 재난:</strong> ${data.event_name} <br>` +
                    `<strong>발생일:</strong> ${data.event_date}`
                ).show();
                
                // 2. 테이블 결과 표시
                $('#table-title').show().text(`성과 요약 (MDD: ${data.mdd_value}%)`);
                $('#analysis-table').html(data.table_html);
                
                // 3. 차트 표시
                if (data.chart_base64) {
                    $('#chart-title').show();
                    $('#chart-img').attr('src', 'data:image/png;base64,' + data.chart_base64);
                }
            },
            error: function(xhr) {
                $('#loading-indicator').hide();
                let errorMsg = '서버 통신 중 오류가 발생했습니다.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = '<strong>분석 실패:</strong> ' + xhr.responseJSON.error;
                }
                $('#error-message').html(errorMsg).show();
            }
        });
    });
    
    // 페이지 로드시 카테고리 로드 시작
    $(document).ready(function() {
        loadDisasterTypes();
    });
</script>

</body>
</html>