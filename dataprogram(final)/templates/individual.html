{% extends "base.html" %}

{% block title %}개별 종목 재난 영향 분석{% endblock %}
{% block nav_individual %}active{% endblock %}

{% block content %}
<style>
    #results-container {
        margin-top: 18px;
    }

    #analysis-chart {
        text-align: center;
        margin-top: 24px;
    }

    #chart-img {
        max-height: 420px;
        border-radius: 12px;
        background: #ffffff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        padding: 6px;
    }

    .sidebar-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .top-list {
        font-size: 0.9rem;
    }

    .top-list li + li {
        margin-top: 4px;
    }
</style>

{% if error %}
<div class="alert alert-danger mt-3">
    {{ error }}
</div>
{% endif %}

<div class="row g-4">

    <!-- 메인 영역: 폼 + 분석 결과 -->
    <div class="col-lg-8">
        <div class="card-box mb-4">
            <h1 class="page-title text-center">개별 종목 재난 영향 분석</h1>
            <p class="page-subtitle text-center">
                선택한 재난 이벤트를 기준으로 특정 종목의 최대 낙폭(MDD)과 성과를 분석합니다.
            </p>

            <p class="text-center mb-3">
                <a href="/" class="text-decoration-none">&laquo; 섹터 분석으로 돌아가기</a>
            </p>

            <form id="individual-analysis-form" class="bg-light p-4 rounded shadow-sm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="type-select" class="form-label">1. 재난 종류 선택 (EventType):</label>
                        <select class="form-select" id="type-select" required>
                            <option value="">-- 종류를 선택하세요 --</option>
                            {% for dtype in disaster_types %}
                                <option value="{{ dtype }}">{{ dtype }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="event-select" class="form-label">2. 분석할 재난 이벤트 선택 (EventName):</label>
                        <select class="form-select" id="event-select" name="event_name" required disabled>
                            <option value="">-- 재난 종류를 먼저 선택하세요 --</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="corp-name-input" class="form-label">3. 분석할 회사 이름 입력 (정확한 종목명):</label>
                    <input type="text" class="form-control" id="corp-name-input" name="corp_name"
                           placeholder="예: 삼성전자" required>
                </div>

                <button type="submit" class="btn btn-primary w-100 mt-2">분석 시작</button>
            </form>
        </div>

        <div id="results-container">
            <div class="card-box">
                <!-- 로딩 인디케이터 -->
                <div id="loading-indicator" class="text-center" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">데이터를 조회하고 차트를 생성 중입니다...</p>
                </div>

                <!-- 에러 메시지 -->
                <div id="error-message" class="alert alert-danger" style="display:none;"></div>

                <!-- 분석 정보 -->
                <div id="analysis-info" class="alert alert-info mt-4" style="display:none;"></div>

                <!-- 성과 요약 테이블 -->
                <h4 id="table-title" style="display:none;" class="mt-4">성과 요약</h4>
                <div id="analysis-table" class="mb-5"></div>

                <!-- 차트 영역 -->
                <h4 id="chart-title" style="display:none;">주가 변동 차트</h4>
                <div id="analysis-chart" style="display:none;">
                    <img id="chart-img" class="img-fluid" alt="종목 분석 차트">
                </div>
            </div>
        </div>
    </div>

    <!-- 사이드바: 상승/하락 TOP5 -->
    <div class="col-lg-4">
        <div id="top-gainers-box" class="hero-box mb-3" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <div>
                    <div class="sidebar-title">상승률 상위 5개 종목</div>
                    <small class="text-muted">이벤트 기준일 전후 수익률 상위 종목</small>
                </div>
            </div>
            <ul class="list-unstyled mt-2 mb-0 top-list" id="top-gainers-list"></ul>
        </div>

        <div id="top-losers-box" class="hero-box" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <div>
                    <div class="sidebar-title">하락률 상위 5개 종목</div>
                    <small class="text-muted">이벤트 기준일 전후 수익률 하위 종목</small>
                </div>
            </div>
            <ul class="list-unstyled mt-2 mb-0 top-list" id="top-losers-list"></ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const typeSelect = $('#type-select');   // 1단계: 재난 종류 선택
    const eventSelect = $('#event-select'); // 2단계: 재난명 선택

    // --- 재난 종류 선택 시, 해당 이벤트 목록 로드 ---
    typeSelect.change(function () {
        const selectedType = $(this).val();
        eventSelect.empty().prop('disabled', true).val('');

        if (!selectedType) {
            eventSelect.append(new Option('-- 재난 종류를 먼저 선택하세요 --', ''))
                       .prop('disabled', true);
            return;
        }

        eventSelect.append(new Option('목록을 불러오는 중...', ''))
                   .prop('disabled', true);

        const encodedType = encodeURIComponent(selectedType);

        $.getJSON(`/api/events_by_type/${encodedType}`, function (data) {
            if (data.error) {
                eventSelect.empty()
                           .append(new Option('데이터 로드 실패', ''))
                           .prop('disabled', true);
                console.error('이벤트 로드 오류:', data.error);
                return;
            }

            eventSelect.empty();
            eventSelect.append(new Option('-- 재난명을 선택하세요 --', ''));
            data.events.forEach(function (event) {
                eventSelect.append(new Option(event, event));
            });
            eventSelect.prop('disabled', false);
        }).fail(function () {
            eventSelect.empty()
                       .append(new Option('데이터 로드 실패', ''))
                       .prop('disabled', true);
        });
    });

    // --- TOP5 리스트 렌더링 유틸 ---
    function renderTopList(list, $targetUl, isLoser) {
        $targetUl.empty();
        list.slice(0, 5).forEach(function (item, idx) {
            const name = item.corp_name || item.name || '종목명';
            const rawRet = item.return_pct ?? item.change_pct ?? item.change_rate ?? null;

            let badgeHtml = '';
            if (rawRet !== null && !isNaN(rawRet)) {
                const signed = (rawRet > 0 ? '+' : '') + rawRet.toFixed(2) + '%';
                const badgeClass = rawRet >= 0 ? 'text-danger' : 'text-primary';
                badgeHtml = `<span class="${badgeClass} ms-2">${signed}</span>`;
            }

            $targetUl.append(
                `<li class="d-flex justify-content-between align-items-center">
                    <span>${idx + 1}. ${name}</span>
                    ${badgeHtml}
                 </li>`
            );
        });
    }

    // --- 폼 제출 로직 ---
    $('#individual-analysis-form').submit(function (e) {
        e.preventDefault();

        const eventName = eventSelect.val();
        const corpName = $('#corp-name-input').val().trim();

        if (!eventName || !corpName) {
            alert('재난명과 회사 이름을 모두 입력/선택해주세요.');
            return;
        }

        // 초기화 & 로딩 표시
        $('#loading-indicator').show();
        $('#analysis-info, #error-message, #analysis-table, #table-title, #chart-title')
            .hide().empty();
        $('#analysis-chart').hide();
        $('#chart-img').attr('src', '');

        // 사이드바도 초기화
        $('#top-gainers-box, #top-losers-box').hide();
        $('#top-gainers-list, #top-losers-list').empty();

        $.ajax({
            type: 'POST',
            url: '/individual_analysis',
            data: { event_name: eventName, corp_name: corpName },
            dataType: 'json',
            success: function (response) {
                $('#loading-indicator').hide();

                if (response.error || response.status !== 'success') {
                    const errorMsg = response.error || '알 수 없는 분석 실패 오류가 발생했습니다.';
                    $('#error-message').html('<strong>분석 실패:</strong> ' + errorMsg).show();
                    return;
                }

                const data = response.analysis_data;

                // 1) 분석 정보
                $('#analysis-info').html(
                    `<strong>분석 종목:</strong> ${data.corp_name} <br>` +
                    `<strong>기준 재난:</strong> ${data.event_name} <br>` +
                    `<strong>발생일:</strong> ${data.event_date}`
                ).show();

                // 2) 성과 요약 테이블
                $('#table-title').show()
                    .text(`성과 요약 (MDD: ${data.mdd_value}%)`);
                $('#analysis-table').html(data.table_html);

                // 3) 차트
                if (data.chart_base64) {
                    $('#chart-title').show();
                    $('#chart-img').attr('src', 'data:image/png;base64,' + data.chart_base64);
                    $('#analysis-chart').show();
                }

                // 4) 상승/하락 TOP5 사이드바
                if (response.top_gainers && response.top_gainers.length > 0) {
                    renderTopList(response.top_gainers, $('#top-gainers-list'), false);
                    $('#top-gainers-box').show();
                }
                if (response.top_losers && response.top_losers.length > 0) {
                    renderTopList(response.top_losers, $('#top-losers-list'), true);
                    $('#top-losers-box').show();
                }
            },
            error: function (xhr) {
                $('#loading-indicator').hide();
                let errorMsg = '서버 통신 중 오류가 발생했습니다.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = '<strong>분석 실패:</strong> ' + xhr.responseJSON.error;
                } else {
                    errorMsg = '<strong>분석 실패:</strong> ' + errorMsg;
                }
                $('#error-message').html(errorMsg).show();
            }
        });
    });
</script>
{% endblock %}
